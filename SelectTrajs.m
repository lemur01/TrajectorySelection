%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% SelectTrajs
% Author: L. Muresan, lam94@cam.ac.uk
% Description:   
% Select, plot and save trajectories generated by TGMM 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
TGMMpath = 'D:\TGMM\Supplementary_Software_6\'
addpath (strcat(TGMMpath,'CATMAID-Matlab-Interface\readTGMM_XMLoutput'))
addpath (strcat(TGMMpath,'Imaris-Matlab-Interface'))
addpath (strcat(TGMMpath,'CATMAID-Matlab-Interface\readTGMM_XMLoutput\Utils'))
addpath (strcat(TGMMpath,'CATMAID-Matlab-Interface\readTGMM_XMLoutput\mylib'))

%% Modify these parameters:

startT = 2 % first time point
endT = 50 % last time point
time = 40; % time point to make selection
timeShape = -1; % time point to recognize the shape of the embryo. If -1, then not used
hollow = 0; % Experimental. If the strucuture hollow set to 1. Tries to eliminate points on the far side of the embryo

pt = 'D:\TGMM\Data\GMEMtracking3D_2018_6_14_13_10_55\XML_finalResult_lht'  % folder with TGMM data
% origFiles = 'D:\\TGMM\\Data\\Series1\\reg\\embryo_dmso_2_new_17-00-44_p00_c00_t%04d_reg_preview.tiff'  
basename = 'D:\TGMM\Data\TGMMruns\GMEMtracking3D_2017_11_9_13_24_26\XML_finalResult_lht\GMEMfinalResult_frame'
%%
idnm = findstr(basename, '\');
pt = basename(1:idnm(end));
%% Read the trajectories from file
[trackingMatrix, svIdxCell]= parseMixtureGaussiansXml2trackingMatrixCATMAIDformat(basename,startT,endT);
%% Selection of cells at given time
% left mouse button to select points and right mouse button to copy selected points to clipboard
idt = find(trackingMatrix(:,8)==time); % select those line in the matrix for which timepoint is time
m = mean(trackingMatrix(idt,[3 4 5]));

if timeShape>0
    idtot = find(trackingMatrix(:,8)==timeShape);
    mtot = mean(trackingMatrix(idtot,[3 4 5]));
end
f = figure; 
plot3(trackingMatrix(idt,3),trackingMatrix(idt,4),trackingMatrix(idt,5), 'g.'); hold on
if timeShape>0
    plot3(trackingMatrix(idtot,3),trackingMatrix(idtot,4),trackingMatrix(idtot,5), 'b.'); hold on
end
legend({strcat('T=',num2str(time)), strcat('T=',num2str(timeShape))})
axis equal
title({'1) Select points of  interest (held left mouse button)'; '2)Right mouse click - Copy Data to Clipboard'; '3) Go to menu: File->Close'})
brush on
uiwait(f)
dat = clipboard('pastespecial')
%%
cameratoolbar('Show');
pointCloud = dat.A_pastespecial';
point = mean(dat.A_pastespecial);
camPos = get(gca, 'CameraPosition'); % camera position
camTgt = get(gca, 'CameraTarget'); % where the camera is pointing to

%% hollow samples
if hollow
pC = dat.A_pastespecial;
r = (pC(:,1)-camPos(1)).^2+(pC(:,2)-camPos(2)).^2+(pC(:,3)-camPos(3)).^2;

[v p ] = sort(r);
[vmax, posmax] =  max(diff(v));
if vmax > median(diff(v))+3*mad(diff(v),1) % remove far away points
    id = p(1:posmax);
    figure; plot(r)
    hold on; plot(id,r(id), 'ro')
    figure
    %[res pos2] = dist2Matrix( pC(id,:),trackingMatrix(idt,[3 4 5]), 1);
    pos  = knnsearch( trackingMatrix(idt,[3 4 5]),pC(id,:));
    plot3(trackingMatrix(idt,3),trackingMatrix(idt,4),trackingMatrix(idt,5), '.'); hold on
    plot3(trackingMatrix(idt(pos),3),trackingMatrix(idt(pos),4),trackingMatrix(idt(pos),5), 'ro');
    title('Selected')
end
else
    %[res pos] = dist2Matrix( pointCloud',trackingMatrix(idt,[3 4 5]), 1);
    pos  = knnsearch( trackingMatrix(idt,[3 4 5]),pointCloud');
    plot3(trackingMatrix(idt,3),trackingMatrix(idt,4),trackingMatrix(idt,5), '.'); hold on
    plot3(trackingMatrix(idt(pos),3),trackingMatrix(idt(pos),4),trackingMatrix(idt(pos),5), 'ro');
    axis equal  
    title('Selected')
end

%% Selected tracks
tracksel = [trackingMatrix(idt(pos),10) trackingMatrix(idt(pos),8)];% trackingMatrix(idt(pos),11) trackingMatrix(idt(pos),12)] ;
idsel = ismember(trackingMatrix(:,10),tracksel(:,1));

%% Plot selected tracks
f = figure; 
sf = sprintf( origFiles, time);
plot3(trackingMatrix(idt,3),trackingMatrix(idt,4),trackingMatrix(idt,5), 'g.'); hold on
% im = Read3d(sf);
% Visu(im, segThresh, 0.2, 'g'); hold on
tracks = unique(trackingMatrix(idt(pos),10));
for k = 1:length(tracks)
    idtr = ismember(trackingMatrix(:,10),tracks(k));
    trsort = sortrows(trackingMatrix(idtr,:),8);
    plot3(trsort(:,3),trsort(:,4),trsort(:,5), 'r.-'); hold on
end
title('Selected tracks (click Enter to save)')
axis equal tight
pause
%% Save selected tracks
allid = ismember(trackingMatrix(:,10),tracks);
seltracks = trackingMatrix(allid,:);
uisave( 'seltracks','seltracks.mat');
