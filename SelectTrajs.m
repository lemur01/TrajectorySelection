%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% SelectTrajs for Imaris 
% Author: lam94@cam.ac.uk
% Description:
%   
% Select trajectories generated by TGMM 
%
%%
addpath 'C:\Users\Lab members\Desktop\For Leila\Supplementary_Software_6\Supplementary_Software_6\CATMAID-Matlab-Interface\readTGMM_XMLoutput'
addpath 'C:\Users\Lab members\Desktop\For Leila\Supplementary_Software_6\Supplementary_Software_6\Imaris-Matlab-Interface'
addpath 'C:\Users\Lab members\Desktop\For Leila\Supplementary_Software_6\Supplementary_Software_6\CATMAID-Matlab-Interface\readTGMM_XMLoutput\Utils'
addpath 'C:\Users\Lab members\Desktop\For Leila\Supplementary_Software_6\Supplementary_Software_6\CATMAID-Matlab-Interface\readTGMM_XMLoutput\mylib'
addpath 'E:\Dropbox (Cambridge University)\Steventon Lab\Lab User Data Imaris Files\Tim\Tim lightsheet Tracking on 2017-09-27 DMSO\readTGMM_XMLoutput - Required for Tim Edit'


%% parameters. TO DO : user input

startT = 0 % first time point
endT = 146 % last time point
time = 40; % time point to make selection
timefinal = -1; % time point to recognize shape of embryo. If -1, then not used
segThresh = 250 % segmentation threshold. Same as for segentation with TGMM. Hopefully will not be necessary in the future

pt = 'E:\Dropbox (Cambridge University)\Steventon Lab\Lab User Data Imaris Files\Tim\Tim lightsheet Tracking on 2017-09-27 DMSO\TGMMruns\GMEMtracking3D_2017_12_15_11_0_43\XML_finalResult_lht\'
%origFiles = 'D:\\Data\\Tim\\Series1\\reg\\embryo_dmso_2_new_17-00-44_p00_c00_t%04d_reg_preview.tiff'  
origFiles = strcat(pt, 'embryo_dmso_2_new_17-00-44_p00_c00_t%04d_reg_preview.tiff' ) 
basename = strcat(pt, 'GMEMfinalResult_frame')
%%
idnm = findstr(basename, '\');
pt = basename(1:idnm(end));
%% Read the trajectories from basename
startT = 0;
endT = 50;
[trackingMatrix, svIdxCell]= parseMixtureGaussiansXml2trackingMatrixCATMAIDformatLeila(basename,startT,endT);

%%
% change here the selection timepoint

idt = find(trackingMatrix(:,8)==time); % select those line in the matrix for which timepoint is time
m = mean(trackingMatrix(idt,[3 4 5]));

if timefinal>0
    idtot = find(trackingMatrix(:,8)==timefinal);
    mtot = mean(trackingMatrix(idtot,[3 4 5]));
end
f = figure; 
plot3(trackingMatrix(idt,3),trackingMatrix(idt,4),trackingMatrix(idt,5), 'g.'); hold on
if timefinal>0
    plot3(trackingMatrix(idtot,3),trackingMatrix(idtot,4),trackingMatrix(idtot,5), 'b.'); hold on
end

axis equal
%% left mouse button to select points and right mouse button to copy selected points to clipboard!!!

%%
%h = clickA3DPoint([trackingMatrix(idt,3),trackingMatrix(idt,4),trackingMatrix(idt,5)]');
%p  = select3d(f);
%%
uiwait(f)
dat = clipboard('pastespecial')
%%
cameratoolbar('Show');
pointCloud = dat.A_pastespecial';

%%

point = mean(dat.A_pastespecial);
camPos = get(gca, 'CameraPosition'); % camera position
camTgt = get(gca, 'CameraTarget'); % where the camera is pointing to


%%
% figure; plot(r)
% hold on; plot(id,r(id), 'ro')
% find the selected points
[res pos] = dist2Matrix( pointCloud',trackingMatrix(idt,[3 4 5]), 1);
%% check if i found the wanted ones
f = figure; 
plot3(trackingMatrix(idt,3),trackingMatrix(idt,4),trackingMatrix(idt,5), '.'); hold on
plot3(trackingMatrix(idt(pos),3),trackingMatrix(idt(pos),4),trackingMatrix(idt(pos),5), 'ro');
axis equal
%% selected tracks
tracksel = [trackingMatrix(idt(pos),10) trackingMatrix(idt(pos),8) trackingMatrix(idt(pos),11) trackingMatrix(idt(pos),12)] ;
idsel = ismember(trackingMatrix(:,10),tracksel(:,1));

f = figure; 
%plot3(trackingMatrix(:,3),trackingMatrix(:,4),trackingMatrix(:,5), 'o');hold on
plot3(trackingMatrix(idt,3),trackingMatrix(idt,4),trackingMatrix(idt,5), '.'); hold on
plot3(trackingMatrix(idsel,3),trackingMatrix(idsel,4),trackingMatrix(idsel,5), 'r.')
%plot3(trackingMatrix(idtot,3),trackingMatrix(idtot,4),trackingMatrix(idtot,5), 'm.'); hold on
axis equal
% friendlyInfo = nodes.item(0).getChildNodes;

%% 

f = figure; 
sf = sprintf( origFiles, time);
%im = Read3d(sf);
%Visu(im, segThresh, 0.2, 'g'); hold on
tracks = unique(trackingMatrix(idt(pos),10));
for k = 1:length(tracks)
    idtr = ismember(trackingMatrix(:,10),tracks(k));
    trsort = sortrows(trackingMatrix(idtr,:),8);
    plot3(trsort(:,4),trsort(:,3),trsort(:,5), 'r.-')
end
%%
%%
stackRes = [1 1 1]
allid = ismember(trackingMatrix(:,10),tracks);
seltracks = trackingMatrix(allid,:);
uisave( 'seltracks','seltracks.mat');
selltracksZYX  = seltracks; seltracksZYX(:,3) = seltracks(:,5); seltracksZYX(:,5) = seltracks(:,3);
seltracks = selltracksZYX;
uisave( 'seltracks','seltracks.mat');
selltracksXZY  =  seltracks; seltracksXZY(:,4) = seltracks(:,5); seltracksXZY(:,5) = seltracks(:,4);
seltracks = selltracksXZY;
uisave( 'seltracks','seltracks.mat');
selltracksYXZ  =  seltracks; seltracksYXZ(:,4) = seltracks(:,3); seltracksYXZ(:,3) = seltracks(:,4);
seltracks = selltracksYXZ;
uisave( 'seltracks','seltracksYXZ.mat');
%%

f = figure; 
%plot3(trackingMatrix(:,3),trackingMatrix(:,4),trackingMatrix(:,5), 'o');hold on
plot3(selltracksZYX(:,3),selltracksZYX(:,4),selltracksZYX(:,5), '.'); hold on
